# Use Docker's internal DNS (Good to keep, but Upstreams make it stable)
resolver 127.0.0.11 valid=30s ipv6=off;

# ==============================================================================
# UPSTREAM DEFINITIONS (The Fix for 500 Errors)
# ==============================================================================
# Nginx resolves these ONCE at startup. No more "host not found" errors.

upstream oauth2_backend {
    server oauth2-proxy:4180;
}

upstream homepage_backend {
    # 'homepage' usually listens on 3000 internally, not 80
    server homepage-app:3000;
}

upstream tea_backend {
    server tea:8080;
}

# ==============================================================================
# 1. MAIN TOOLS DASHBOARD (tools.blue-expert.com)
# ==============================================================================

server {
    listen 80;
    server_name tools.blue-expert.com;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl;
    server_name tools.blue-expert.com;

    ssl_certificate /etc/letsencrypt/live/tools.blue-expert.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/tools.blue-expert.com/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # --- OAuth2 Proxy ---
    location /oauth2/ {
        # USE UPSTREAM NAME (No '$' sign)
        proxy_pass       http://oauth2_backend;
        
        proxy_set_header Host                    $host;
        proxy_set_header X-Real-IP               $remote_addr;
        proxy_set_header X-Scheme                $scheme;
        proxy_set_header X-Auth-Request-Redirect $request_uri;

        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }

    location = /oauth2/auth {
        # USE UPSTREAM NAME
        proxy_pass       http://oauth2_backend;
        
        proxy_set_header Host             $host;
        proxy_set_header X-Real-IP        $remote_addr;
        proxy_set_header X-Forwarded-Uri  $request_uri;
        proxy_set_header X-Scheme              $scheme;
        proxy_set_header X-Forwarded-Proto     $scheme;
        proxy_set_header X-Forwarded-Host      $host;
        proxy_set_header X-Auth-Request-Redirect $scheme://$host$request_uri;
        proxy_set_header Cookie $http_cookie;
        proxy_pass_request_body off;
        proxy_set_header Content-Length   "";
    }

    # --- Main App ---
    location / {
        auth_request /oauth2/auth;
        error_page 401 =403 /oauth2/sign_in;

        auth_request_set $user   $upstream_http_x_auth_request_user;
        auth_request_set $email  $upstream_http_x_auth_request_email;
        proxy_set_header X-User  $user;
        proxy_set_header X-Email $email;

        # USE UPSTREAM NAME
        proxy_pass http://homepage_backend;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;

        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }
}


# ==============================================================================
# 2. TEA APPLICATION (tea.tools.blue-expert.com)
# ==============================================================================

server {
    listen 80;
    server_name tea.tools.blue-expert.com;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl;
    server_name tea.tools.blue-expert.com;

    ssl_certificate /etc/letsencrypt/live/tea.tools.blue-expert.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/tea.tools.blue-expert.com/privkey.pem;

    # --- OAuth2 Check ---
    location = /oauth2/auth {
        # USE UPSTREAM NAME
        proxy_pass       http://oauth2_backend;
        
        proxy_set_header Host             $host;
        proxy_set_header X-Real-IP        $remote_addr;
        proxy_set_header X-Forwarded-Uri  $request_uri;
        proxy_set_header X-Scheme              $scheme;
        proxy_set_header X-Forwarded-Proto     $scheme;
        proxy_set_header X-Forwarded-Host      $host;
        proxy_set_header X-Auth-Request-Redirect $scheme://$host$request_uri;
        proxy_set_header Cookie $http_cookie;
        proxy_pass_request_body off;
        proxy_set_header Content-Length   "";
    }

    # --- Tea App ---
    location / {
        auth_request /oauth2/auth;
        
        # Redirect to Main Domain for login if unauthorized
        error_page 401 =302 https://tools.blue-expert.com/oauth2/sign_in?rd=https://$host$request_uri;

        # USE UPSTREAM NAME
        proxy_pass http://tea_backend;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;

        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
        proxy_read_timeout 300;
    }
}
