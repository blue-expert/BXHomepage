# Use Docker's internal DNS so service names resolve at runtime.
resolver 127.0.0.11 valid=30s ipv6=off;

# ==============================================================================
# 1. MAIN TOOLS DASHBOARD (tools.blue-expert.com)
# Acts as the "Auth Hub" for all subdomains
# ==============================================================================

# --- HTTP (Redirect to HTTPS & Certbot) ---
server {
    listen 80;
    server_name tools.blue-expert.com;

    # Allow Certbot to validate ownership
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Redirect everything else to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# --- HTTPS (Protected) ---
server {
    listen 443 ssl;
    server_name tools.blue-expert.com;

    # SSL Certificates
    ssl_certificate /etc/letsencrypt/live/tools.blue-expert.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/tools.blue-expert.com/privkey.pem;

    # Optimization & Security
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # ----------------------------------------------------------------------
    # OAUTH2 PROXY ENDPOINTS
    # These are unprotected so the user can initiate the login flow.
    # ----------------------------------------------------------------------

    # Handles the OAuth2 Proxy Endpoints (Sign in, Callback, etc.)
    set $oauth2_proxy http://oauth2-proxy:4180;

    location /oauth2/ {
        proxy_pass       $oauth2_proxy;
        proxy_set_header Host                    $host;
        proxy_set_header X-Real-IP               $remote_addr;
        proxy_set_header X-Scheme                $scheme;
        proxy_set_header X-Auth-Request-Redirect $request_uri;

        # Increase buffers for Microsoft OAuth Large Cookies
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }

    # Internal location used by 'auth_request' to check validity
    location = /oauth2/auth {
        proxy_pass       $oauth2_proxy;
        proxy_set_header Host             $host;
        proxy_set_header X-Real-IP        $remote_addr;
        proxy_set_header X-Forwarded-Uri  $request_uri;
        proxy_set_header X-Scheme              $scheme;
        proxy_set_header X-Forwarded-Proto     $scheme;
        proxy_set_header X-Forwarded-Host      $host;
        proxy_set_header X-Auth-Request-Redirect $scheme://$host$request_uri;
        # Forward cookies from client to oauth2-proxy
        proxy_set_header Cookie $http_cookie;
        # Nginx must not discard the body
        proxy_pass_request_body off;
        proxy_set_header Content-Length   "";
    }

    # ----------------------------------------------------------------------
    # MAIN APP PROXY (PROTECTED)
    # ----------------------------------------------------------------------
    set $homepage_app http://homepage-app:80;

    location / {
        # 1. Check every request with the OAuth provider
        auth_request /oauth2/auth;

        # 2. If not logged in (401), redirect to the Sign-In page
        error_page 401 =403 /oauth2/sign_in;

        # 3. Pass user details to the backend app (Optional but useful)
        auth_request_set $user   $upstream_http_x_auth_request_user;
        auth_request_set $email  $upstream_http_x_auth_request_email;
        proxy_set_header X-User  $user;
        proxy_set_header X-Email $email;

        proxy_pass $homepage_app;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;

        # Increase buffers for Microsoft OAuth Large Cookies
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
    }
}


# ==============================================================================
# 2. TEA APPLICATION (tea.tools.blue-expert.com)
# Protected via the Main Dashboard's Cookie
# ==============================================================================

# --- HTTP (Redirect to HTTPS & Certbot) ---
server {
    listen 80;
    server_name tea.tools.blue-expert.com;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# --- HTTPS (Protected) ---
server {
    listen 443 ssl;
    server_name tea.tools.blue-expert.com;

    # SSL Certificates (Change path if you generated a separate cert)
    ssl_certificate /etc/letsencrypt/live/tea.tools.blue-expert.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/tea.tools.blue-expert.com/privkey.pem;

    # ----------------------------------------------------------------------
    # OAUTH2 SUBDOMAIN LOGIC
    # ----------------------------------------------------------------------

    set $oauth2_proxy http://oauth2-proxy:4180;

    # We still need this internal block to perform the check
    location = /oauth2/auth {
        proxy_pass       $oauth2_proxy;
        # Keep the actual host so cookies can be validated correctly
        proxy_set_header Host             $host;
        proxy_set_header X-Real-IP        $remote_addr;
        proxy_set_header X-Forwarded-Uri  $request_uri;
        proxy_set_header X-Scheme              $scheme;
        proxy_set_header X-Forwarded-Proto     $scheme;
        proxy_set_header X-Forwarded-Host      $host;
        proxy_set_header X-Auth-Request-Redirect $scheme://$host$request_uri;
        # Forward cookies from client to oauth2-proxy (critical for cross-subdomain auth)
        proxy_set_header Cookie $http_cookie;
        proxy_pass_request_body off;
        proxy_set_header Content-Length   "";
    }

    # ----------------------------------------------------------------------
    # TEA APP PROXY (PROTECTED)
    # ----------------------------------------------------------------------
    set $tea_upstream http://tea:8080;

    location / {
        # 1. Check if the user has the wildcard cookie
        auth_request /oauth2/auth;

        # 2. If not logged in, redirect to the MAIN DOMAIN (tools) to login
        # We pass the current URL (?rd=...) so they come back here after login
        error_page 401 =302 https://tools.blue-expert.com/oauth2/sign_in?rd=https://$host$request_uri;

        proxy_pass $tea_upstream;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;

        # Increase buffers for Microsoft OAuth Large Cookies
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;

        # Optional: Increase timeout for long calculations
        proxy_read_timeout 300;
    }
}
